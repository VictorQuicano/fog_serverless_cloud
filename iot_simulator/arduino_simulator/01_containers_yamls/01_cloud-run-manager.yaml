---
- name: Extraer nombre del archivo del path
  set_fact:
    file_name: "{{ file_path.split('/')[-1] }}"
    city_folder: "{{ file_path.split('/')[0] }}"

- name: Generar nombre único para el servicio
  set_fact:
    service_name: "sensor-{{ city_name | lower }}-{{ container_number }}-{{ 100000 | random | string }}"

- name: Definir archivo de cuenta de servicio
  set_fact:
    service_account_file: "../../../sa-ansible-key.json"

- name: Autenticar gcloud
  command: "gcloud auth activate-service-account --key-file '{{ service_account_file }}'"
  changed_when: false

- name: Crear servicio Cloud Run (gcloud)
  command: >
    gcloud run deploy "{{ service_name }}"
    --image "gcr.io/arduino-tesis/iot-sensor-simulator"
    --region "{{ target_region }}"
    --project "{{ project_id }}"
    --set-env-vars "FILE_TO_PROCESS=gs://{{ bucket_name }}/{{ file_path }},TOPIC=projects/{{ project_id }}/topics/{{ city_name }},INTERVAL_SECONDS=60"
    --memory 512Mi
    --cpu 1
    --timeout 300
    --allow-unauthenticated
    --quiet
  register: deploy_result
  
- name: Obtener URL del servicio
  command: >
    gcloud run services describe "{{ service_name }}"
    --region "{{ target_region }}"
    --project "{{ project_id }}"
    --format "value(status.url)"
  register: service_url
  changed_when: false

- name: Mostrar información del servicio creado
  debug:
    msg: |
      Ciudad: {{ city_name }}
      Servicio: {{ service_name }}
      Región: {{ target_region }}
      Archivo: {{ file_name }}
      URL: {{ service_url.stdout }}