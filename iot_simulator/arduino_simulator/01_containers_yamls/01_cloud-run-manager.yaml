---
- name: Extraer nombre del archivo del path
  set_fact:
    file_name: "{{ file_path.split('/')[-1] }}"
    city_folder: "{{ file_path.split('/')[0] }}"

- name: Generar nombre único para el servicio
  set_fact:
    service_name: "sensor-{{ city_name | lower }}-{{ container_number }}-{{ 100000 | random | string }}"

- name: Definir archivo de cuenta de servicio
  set_fact:
    service_account_file: "../../../sa-ansible-key.json"

- name: Autenticar gcloud
  command: "gcloud auth activate-service-account --key-file '{{ service_account_file }}'"
  changed_when: false

- name: Crear Cloud Run Job (gcloud)
  command: >
    gcloud run jobs create "{{ service_name }}"
    --image "gcr.io/arduino-tesis/iot-sensor-simulator"
    --region "{{ target_region }}"
    --project "{{ project_id }}"
    --set-env-vars "FILE_TO_PROCESS=gs://{{ bucket_name }}/{{ file_path }},TOPIC=projects/{{ project_id }}/topics/{{ city_name }},INTERVAL_SECONDS=60"
    --memory 4Gi
    --task-timeout 24h
    --quiet
  register: deploy_result

- name: Ejecutar Cloud Run Job
  command: >
    gcloud run jobs execute "{{ service_name }}"
    --region "{{ target_region }}"
    --project "{{ project_id }}"
    --quiet
  register: execute_result

- name: Mostrar información del job creado
  debug:
    msg: |
      Ciudad: {{ city_name }}
      Job: {{ service_name }}
      Región: {{ target_region }}
      Archivo: {{ file_name }}
      Execution ID: {{ execute_result.stdout if execute_result.stdout is defined else 'Unknown' }}